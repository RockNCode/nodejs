<html>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-database.js"></script>
        <script src="http://stevenlevithan.com/assets/misc/date.format.js"></script>
        <H2>Testing.</H2>
        <input type="text" id="uname" name="uname" required
               minlength="4" maxlength="13"
               placeholder="Account name" />
        <input type="number" id="guess" name="guess" required
               minlength="4" maxlength="8"
               placeholder="0.0" />
        <select name="cars" id="staked" name="staked">
          <option >0.1</option>
          <option >0.15</option>
          <option >0.2</option>

         </select>

        <button id="buttonGuess">
          Add guess
        </button>
        <script>
            $( "#buttonGuess" ).click(function() {
                var userName = $("#uname").val();
                var guess = $("#guess").val()
                var stakedAmount = $("#staked").val()
                // alert("Button clicked")
                $.get( `https://us-central1-dbtest-f5ad8.cloudfunctions.net/addGuess?accountName=${userName}&guessPrice=${guess}&staked=${stakedAmount}`, function( data ) {
                //$.get( `http://localhost:5000/dbtest-f5ad8/us-central1/addGuess?accountName=${userName}&guessPrice=${guess}&staked=${stakedAmount}`, function( data ) {
                    console.log("success");
                }).fail(()=>{
                    console.log("failure");
                    //alert("Failed update database.");
                });

                // $.get( `https://us-central1-dbtest-f5ad8.cloudfunctions.net/getLastGuesses`, function( data ) {
                //     console.log("success " + JSON.stringify(data.val(),undefined,2));
                // }).fail(()=>{
                //     console.log("failure " + JSON.stringify(data.val(),undefined,2));
                //     //alert("Failed update database.");
                // });
            });
        </script>
        <H3>Current bitcoin price: </H3>
        <H3 id="bcprice" name="bcprice"></H3>
        <H3>Current closest guess: </H3>
        <H3 id="closest_guess" name="closest_guess"></H3>
        <!-- <H4> Latest guesses</H4>
        <ul id="latest"></ul> -->
        <H4> Time slot 1 : 20:00 to 11:59 next day</H4>
        <ul id="timeTable1">
        </ul>
        <H4> Time slot 2 : 12:00 to 17:59</H4>
        <ul id="timeTable2">
        </ul>
        <H4> Time slot 3 : 18:00 to 19:59</H4>
        <ul id="timeTable3">
        </ul>
        <script>
            $.get( "https://api.coindesk.com/v1/bpi/currentprice.json", function( data ) {
                  console.log(JSON.stringify(data,undefined,2));
                  var obj = JSON.parse(data);
                  var price = obj.bpi.USD.rate;
                //   alert( "Price is " + price);
                  $("#bcprice").text(price);

                }).fail(()=>{
                    console.log("failure");
                    alert("Failed to get price");
                });
        </script>

        <script>
          // Initialize Firebase
          var closestPrice = -100000;
          var closestAccount ="";
          var lowestGap = 500000;
          console.log("Initializing firebase")
          var config = {
            apiKey: "AIzaSyAn73QwXUdyORyym5iCMo1qYTKirPBMYSw",
            authDomain: "dbtest-f5ad8.firebaseapp.com",
            databaseURL: "https://dbtest-f5ad8.firebaseio.com",
            projectId: "dbtest-f5ad8",
            storageBucket: "dbtest-f5ad8.appspot.com",
            messagingSenderId: "386160058842"
          };

          var app = firebase.initializeApp(config);
          var database = app.database();

          var todayDate = new Date();
          var earliestBidDate = new Date(todayDate);
          var latestBidDate = new Date(todayDate);

          // First we get the current game window
          if (todayDate.getUTCHours() < 20 ){
            var day = todayDate.getUTCDate();
            earliestBidDate.setUTCDate(day - 1);
          } else {
            var day = todayDate.getUTCDate();
            latestBidDate.setUTCDate(day + 1);
          }

          earliestBidDate.setUTCHours(20);
          earliestBidDate.setUTCMinutes(0);
          earliestBidDate.setUTCSeconds(0);
          earliestBidDate.setUTCMilliseconds(0);

          latestBidDate.setUTCHours(19);
          latestBidDate.setUTCMinutes(59);
          latestBidDate.setUTCSeconds(59);
          latestBidDate.setUTCMilliseconds(59);

          console.log("Todays UTC date : " + todayDate.toUTCString());
          console.log("earliest Bid : " + earliestBidDate.toUTCString());
          console.log("latest Bid: " + latestBidDate.toUTCString());
          // we iterate through the date.
          var dateIt = new Date(earliestBidDate);
          var mRefTime1; // timeslot 1 reference
          var mRefTime2; // timeslot 2 reference
          var mRefTime3; // timeslot 3 reference

          while(dateIt < latestBidDate) {
            var dateString = dateFormat(dateIt,"isoUtcDateTime");
            dateString = dateString.substring(0,dateString.length-1);
            var hours = dateIt.getUTCHours();
            // only add references for the 3 relevant windows
            switch(hours) {
              case 20:
                mRefTime1 = database.ref(`/tables/guessByDate/${dateString}`);
              break;
              case 12:
                mRefTime2 = database.ref(`/tables/guessByDate/${dateString}`);
              break;
              case 18:
                mRefTime3 = database.ref(`/tables/guessByDate/${dateString}`);
              break;
            }
            //console.log("Hours : "+ hours);
            dateIt.setUTCHours(++hours);
          }
          mRefTime1.on('child_added', (data)=>{ appendToCurrentTable(data,"timeTable1") });
          mRefTime2.on('child_added', (data)=>{ appendToCurrentTable(data,"timeTable2") });
          mRefTime3.on('child_added', (data)=>{ appendToCurrentTable(data,"timeTable3") });

          function appendToCurrentTable(data,timeTable) {
            console.log(data.val());
            var name = data.val().accountName;
            var price = data.val().guessPrice;
            var date = data.val().timestamp;
            var staked = data.val().staked;
            $(`#${timeTable}`).append(`<li> ${date} : ${name} : $ ${price} USD , staked : ${staked}</li>`)
            // closest guess
            var bitcoinPriceText = $("#bcprice").text();
            var bitcoinPrice = Number(bitcoinPriceText.replace(/[^0-9.-]+/g,""));
            console.log( "Bitcoin price : " + bitcoinPrice);
            if(closestPrice === -100000) {
              closestPrice = price;
              closestAccount = name;
            } else {
              console.log(" Old close : "+ closestPrice +"checking " + price + "against btc : " + bitcoinPrice);
              if( Math.abs(price - bitcoinPrice) < lowestGap) {
                console.log("new closest :"+ price);
                closestPrice = price;
                closestAccount = name;
                lowestGap = Math.abs(price - bitcoinPrice);
              }
            }
            $("#closest_guess").text(`${closestAccount} : ${closestPrice}`);
          }
        </script>

    </body>

</html>
